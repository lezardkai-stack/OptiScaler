name: Manual Build

on:
  workflow_dispatch: # 允許手動點擊按鈕編譯

env:
  SOLUTION_FILE_PATH: .
  BUILD_CONFIGURATION: Release

permissions:
  contents: read

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0         
        submodules: 'true'

    # 提取版本號邏輯
    - name: Extract OptiScaler Version
      id: get_version
      working-directory: ${{ github.workspace }}
      shell: powershell
      run: |
        $resourceFile = ".\OptiScaler\resource.h"
        if (-Not (Test-Path $resourceFile)) { 
            Write-Error "Resource file not found"; exit 1 
        }
        function Get-Version-Component {
            param ([string]$pattern, [string]$replacement)
            $line = Get-Content $resourceFile | Select-String -Pattern $pattern | Select-Object -First 1
            return ($line.Line -replace $replacement).Trim()
        }
        $major = Get-Version-Component 'VER_MAJOR_VERSION' '#define VER_MAJOR_VERSION\s+'
        $minor = Get-Version-Component 'VER_MINOR_VERSION' '#define VER_MINOR_VERSION\s+'
        $hotfix = Get-Version-Component 'VER_HOTFIX_VERSION' '#define VER_HOTFIX_VERSION\s+'
        $build = Get-Version-Component 'VER_BUILD_NUMBER' '#define VER_BUILD_NUMBER\s+'
        $version = "v$major.$minor.$hotfix-pre$build"
        $date = Get-Date -Format "yyyyMMdd"
        $outputFileName = "OptiScaler_${version}_${date}"
        "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
        "filename=$outputFileName" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v2

    # 執行編譯（這是最關鍵的一步）
    - name: Build
      working-directory: ${{env.GITHUB_WORKSPACE}}
      run: msbuild /m /p:Configuration=${{env.BUILD_CONFIGURATION}} ${{env.SOLUTION_FILE_PATH}} /verbosity:minimal

    # 壓縮產出的 DLL (路徑已修正為標準 Release 路徑)
    - name: Compress the artifact 
      shell: powershell
      run: |
        $zipName = "${{ steps.get_version.outputs.filename }}.7z"
        # 這裡會抓取 x64/Release 資料夾下所有的編譯產物
        7z a -r "${{ github.workspace }}\$zipName" "${{ github.workspace }}\x64\Release\*"

    # 上傳到 GitHub Actions 介面供你點擊下載
    - name: Upload to Actions Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.get_version.outputs.filename }}
        path: ${{ github.workspace }}\*.7z
        if-no-files-found: error
