name: Manual Build

on:
  workflow_dispatch: # 讓你可以在 Actions 頁面手動點擊按鈕編譯

env:
  SOLUTION_FILE_PATH: .
  BUILD_CONFIGURATION: Release

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0         
        submodules: 'true'

    # 自動抓取版本號（保留你原本的邏輯）
    - name: Extract OptiScaler Version
      id: get_version
      working-directory: ${{ github.workspace }}
      shell: powershell
      run: |
        $resourceFile = ".\OptiScaler\resource.h"
        if (-Not (Test-Path $resourceFile)) { exit 1 }
        function Get-Version-Component {
            param ([string]$pattern, [string]$replacement)
            $line = Get-Content $resourceFile | Select-String -Pattern $pattern | Select-Object -First 1
            return ($line.Line -replace $replacement).Trim()
        }
        $major = Get-Version-Component 'VER_MAJOR_VERSION' '#define VER_MAJOR_VERSION\s+'
        $minor = Get-Version-Component 'VER_MINOR_VERSION' '#define VER_MINOR_VERSION\s+'
        $hotfix = Get-Version-Component 'VER_HOTFIX_VERSION' '#define VER_HOTFIX_VERSION\s+'
        $build = Get-Version-Component 'VER_BUILD_NUMBER' '#define VER_BUILD_NUMBER\s+'
        $version = "v$major.$minor.$hotfix-pre$build"
        $date = Get-Date -Format "yyyyMMdd"
        $outputFileName = "OptiScaler_${version}_${date}"
        "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
        "filename=$outputFileName" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v2

    # 執行編譯
    - name: Build
      working-directory: ${{env.GITHUB_WORKSPACE}}
      run: msbuild /m /p:Configuration=${{env.BUILD_CONFIGURATION}} ${{env.SOLUTION_FILE_PATH}} /verbosity:minimal
      
    # 壓縮產出物 (DLL 檔案)
    - name: Compress the artifact 
      shell: powershell
      run: |
        $zipName = "${{ steps.get_version.outputs.filename }}.7z"
        # 注意：這裡路徑需對應 MSBuild 產出的位置
        7z a -r "${{ github.workspace }}\$zipName" "${{ github.workspace }}\x64\Release\*"

    # 【最重要】上傳到 Actions 頁面供下載
    - name: Upload to Actions Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ steps.get_version.outputs.filename }}
        path: ${{ github.workspace }}\*.7z
        if-no-files-found: error
